services:
  mssql:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: emaat-mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${DB_PASSWORD}
      MSSQL_PID: "Developer"
    ports:
      - "${DB_PORT:-1433}:1433"
    volumes:
      - emaat_mssql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q \"SELECT 1\" -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

  # This is a one-shot container that runs your schema.sql against the DB
  mssql-init:
    image: mcr.microsoft.com/mssql-tools:latest
    container_name: emaat-mssql-init
    depends_on:
      mssql:
        condition: service_healthy
    environment:
      DB_HOST: ${DB_HOST}
      DB_PORT: ${DB_PORT}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
    volumes:
      - ./src/database/schema.sql:/schema.sql:ro
    entrypoint: ["/bin/bash", "-lc"]
    command: >
      "
      echo 'Creating database if not exists...';
      /opt/mssql-tools/bin/sqlcmd -S ${DB_HOST},${DB_PORT} -U ${DB_USER} -P ${DB_PASSWORD} -Q \"IF DB_ID('${DB_NAME}') IS NULL CREATE DATABASE [${DB_NAME}]\";

      echo 'Running schema.sql...';
      /opt/mssql-tools/bin/sqlcmd -S ${DB_HOST},${DB_PORT} -U ${DB_USER} -P ${DB_PASSWORD} -d ${DB_NAME} -i /schema.sql;

      echo 'DB init done.';
      "

volumes:
  emaat_mssql_data:
